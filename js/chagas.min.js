window.onload=function(){var e=function(e,o){var t=d[o].name,n=d[o].center,r=d[o].zoom,a={center:n,extent:ol.proj.transformExtent([-91.9,19.2,-86.3,22],"EPSG:4326","EPSG:3857"),zoom:r,minZoom:8};_.setView(new ol.View(a));for(var s=new ol.style.Style({image:""}),l=new ol.style.Style({image:new ol.style.Icon({opacity:.75,size:[594,594],scale:15/594,src:"./img/icons/opossum-red.svg"})}),c=new ol.style.Style({image:new ol.style.Icon({opacity:.75,size:[594,594],scale:15/594,src:"./img/icons/opossum-green.svg"})}),i=0,m=e.length;i<m;i++){var g=e[i];"Todas"==t||g.get("Localidad")==t?g.get("Captura")?g.setStyle("Positivo"==g.get("Dx_T_cruzi")?l:c):g.setStyle(null):g.setStyle(s)}},o=function(e){for(var o=new ol.source.Vector({}),t=(new ol.layer.Vector({source:o}),0),n=v.length;t<n;t++)for(var r=v[t].getSource().getFeatures(),a=0,s=r.length;a<s;a++){var l=r[a];l.get("Localidad")==e&&o.addFeature(l)}return o.getFeatures()},t=function(e,o){for(var t=new ol.Sphere(6378137),n=e.length,r=[],a=0;a<n;a++)r[a]=[];for(a=0;a<n;a++){var s=e[a].getGeometry().getCoordinates(),l=ol.proj.transform(s,"EPSG:3857","EPSG:4326");r[a][a]=0;for(var c=a+1;c<n;c++){var i=e[c].getGeometry().getCoordinates(),m=ol.proj.transform(i,"EPSG:3857","EPSG:4326"),g=0;t.haversineDistance(l,m)<o&&(g=1),r[a][c]=g,r[c][a]=g}}return r},n=function(e,o){var t=Math.pow(10,o),n=e*t;return Math.round(n)/t};function r(e){if(e<-6.5)return 0;if(e>6.5)return 1;for(var o=1,t=0,n=1,r=0,a=Math.exp(-23);Math.abs(n)>a;)t+=n=.3989422804*Math.pow(-1,r)*Math.pow(e,r)/(2*r+1)/Math.pow(2,r)*Math.pow(e,r+1)/o,o*=++r;return t+=.5}var a=["Infected.geojson","NonInfected.geojson","EmptyTrap.geojson"],s=(new ol.style.Style({image:""}),new ol.style.Style({image:new ol.style.Icon({opacity:.75,size:[594,594],scale:15/594,src:"./img/icons/opossum-red.svg"})})),l=new ol.style.Style({image:new ol.style.Icon({opacity:.75,size:[594,594],scale:15/594,src:"./img/icons/opossum-green.svg"})}),c=new ol.style.Style({image:new ol.style.Circle({radius:5,stroke:new ol.style.Stroke({width:.7,color:"#115CD6"})})}),m=new ol.style.Style({image:new ol.style.Circle({radius:20,stroke:new ol.style.Stroke({width:.7,color:"red"})})}),g=[s,l,c],d={0:{name:"Todas",center:ol.proj.fromLonLat([-89.43944444,20.91916667]),zoom:10,infected:160,non_infected:166,empty:874},310070001:{name:"Cacalchén",center:ol.proj.fromLonLat([-89.22818,20.9830986111]),zoom:15,distance:1300,infected:13,non_infected:30,empty:57},310200001:{name:"Chicxulub Pueblo",center:ol.proj.fromLonLat([-89.5150761111,21.1372894444]),zoom:15,distance:800,infected:20,non_infected:9,empty:71},310360001:{name:"Homún",center:ol.proj.fromLonLat([-89.2856605556,20.7394877778]),zoom:15,distance:1500,infected:5,non_infected:8,empty:87},310450001:{name:"Kopomá",center:ol.proj.fromLonLat([-89.8995258333,20.64897]),zoom:15,distance:800,infected:14,non_infected:15,empty:71},310500093:{name:"Komchén",center:ol.proj.fromLonLat([-89.6616605556,21.1034636111]),zoom:15,distance:1100,infected:16,non_infected:20,empty:64},310510001:{name:"Mocochá",center:ol.proj.fromLonLat([-89.4520555556,21.1056844444]),zoom:15,distance:800,infected:7,non_infected:1,empty:92},310520001:{name:"Motul",center:ol.proj.fromLonLat([-89.2839247222,21.0955505556]),zoom:14,distance:1700,infected:11,non_infected:20,empty:69},310670001:{name:"Seyé",center:ol.proj.fromLonLat([-89.3722527778,20.8369866667]),zoom:15,distance:1300,infected:13,non_infected:19,empty:68},310680001:{name:"Sinanché",center:ol.proj.fromLonLat([-89.1857833333,21.225595]),zoom:15,distance:900,infected:21,non_infected:12,empty:67},310870001:{name:"Tetiz",center:ol.proj.fromLonLat([-89.9334488889,20.9619116667]),zoom:15,distance:1e3,infected:15,non_infected:16,empty:69},310900001:{name:"Timucuy",center:ol.proj.fromLonLat([-89.513505,20.8105080556]),zoom:15,distance:1e3,infected:12,non_infected:5,empty:83},310930001:{name:"Tixkokob",center:ol.proj.fromLonLat([-89.3949655556,21.0025677778]),zoom:15,distance:1400,infected:13,non_infected:11,empty:76}},f={center:d[0].center,extent:ol.proj.transformExtent([-91.9,19.2,-86.3,22],"EPSG:4326","EPSG:3857"),zoom:d[0].zoom,minZoom:8},p=new ol.layer.Tile({source:new ol.source.OSM({url:"http://{a-c}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png"})}),u=a.length,v=[];for(i=0;i<u;i++){var y=new ol.source.Vector({url:"./data/"+a[i],format:new ol.format.GeoJSON({defaultDataProjection:"EPSG: 3857"})}),h=new ol.layer.Vector({source:y,style:g[i],visible:!0});v.push(h)}var w=new ol.layer.Vector({}),_=new ol.Map({target:"map",layers:[p].concat(v),view:new ol.View(f)});_.on("pointermove",function(e){if(e.dragging)$(element).popover("destroy");else{var o=_.getEventPixel(e.originalEvent),t=_.forEachLayerAtPixel(o,function(){return!0},null,function(e){return e!==p});_.getTargetElement().style.cursor=t?"pointer":""}}),$("input[id|=visible]").change(function(){v[this.value-1].setVisible(this.checked)}),element=document.getElementById("popup");var S=new ol.Overlay({element:element,positioning:"bottom-center",stopEvent:!1});_.addOverlay(S),_.on("click",function(e){var o=_.forEachFeatureAtPixel(e.pixel,function(e,o){return e},null,function(e){return e!==p});if(o){S.setPosition(e.coordinate);var t="<strong>"+o.get("Cve_Casa")+"</strong><br>";t+=o.get("HARP")+"<br>",t+=o.get("Fecha")+"<br>",t+="GPS: "+o.get("Punto_GPS"),$(element).attr("data-placement","top"),$(element).attr("data-html",!0),$(element).attr("data-content",t),$(element).popover("show");var n=o.getGeometry().getCoordinates();n=ol.proj.transform(n,"EPSG:3857","EPSG:4326");var r="<strong>ID: </strong>"+o.get("Cve_Casa")+"<br>";r+="<strong>HARP: </strong>"+o.get("HARP")+"<br>",r+="<strong>Fecha: </strong>"+o.get("Fecha")+"<br>",r+="<strong>Localidad: </strong>"+o.get("Localidad")+"<br>",r+="<strong>Punto GPS: </strong>"+o.get("Punto_GPS")+"<br>",r+="<strong>Lon: </strong>"+n[0].toFixed(8)+"<br>",r+="<strong>Lat: </strong>"+n[1].toFixed(8)+"<br>",r+="<strong>LT (mm): </strong>"+o.get("LT_mm")+"<br>",r+="<strong>LC (mm): </strong>"+o.get("LC_mm")+"<br>",r+="<strong>Edad: </strong>"+o.get("Edad")+"<br>",r+="<strong>Sexo: </strong>"+o.get("Sexo")+"<br>",r+="<strong>Edo_Reprod: </strong>"+o.get("Edo_Reprod")+"<br>",r+="<strong>Dx_T_cruzi: </strong>"+o.get("Dx_T_cruzi")+"<br>",$("#feature-data").html(r)}else $(element).popover("destroy"),$("#feature-data").html("")}),$("#select-localidad").change(function(){var o=$(this).val();$("#stats").html("");for(var t=0,n=v.length;t<n;t++){var r=v[t].getSource().getFeatures();e(r,o)}"0"==o?$("#calc-btn").prop("disabled",!0):$("#calc-btn").prop("disabled",!1)}),$("#calc-btn").click(function(){var e=function(e,n){w.setMap(null);for(var a=new ol.source.Vector({}),s=d[e].name,l=o(s),c=l.length,i=0,g=[],f=0;f<c;f++){var p=(oe=l[f]).get("Captura"),u=oe.get("Dx_T_cruzi");p&&"Positivo"==u?(i++,g[f]=1):g[f]=0}var v=i/c,y=t(l,n),h=0;for(f=0;f<c;f++)for(x=0;x<c;x++)h+=y[f][x];var S=0,L=0,b=0,P=0;for(f=0;f<c;f++)for(b+=(g[f]-v)*(g[f]-v),x=0;x<c;x++)S+=y[f][x]*(g[f]-v)*(g[x]-v),L+=y[f][x]*g[f]*g[x],f!=x&&(P+=g[f]*g[x]);var G=c/h*S/b,z=L/P,E=-1/(c-1),M=h/(c*(c-1)),j=0;for(f=0;f<c;f++)for(var x=0;x<c;x++)j+=Math.pow(y[f][x]+y[x][f],2);j/=2;var C=0;for(f=0;f<c;f++){var $=0;for(x=0;x<c;x++)$+=y[f][x]+y[x][f];C+=$*$}var I=0,T=0;for(f=0;f<c;f++)I+=Math.pow(g[f]-v,4),T+=Math.pow(g[f]-v,2);var V=(c*((c*c-3*c+3)*j-c*C+3*h*h)-(I/=c)/(T=Math.pow(T/c,2))*((c*c-c)*j-2*c*C+6*h*h))/((c-1)*(c-2)*(c-3)*h*h)-E*E,F=0,k=0,D=0,A=0;for(f=0;f<c;f++)F+=g[f],k+=Math.pow(g[f],2),D+=Math.pow(g[f],3),A+=Math.pow(g[f],4);for(var R=c,H=c-1;H>c-4;H--)R*=H;for(j=0,f=0;f<c;f++)for(x=0;x<c;x++)f!=x&&(j+=Math.pow(y[f][x]+y[x][f],2));j/=2;for(C=0,f=0;f<c;f++){for($=0,x=0;x<c;x++)f!=x&&($+=y[f][x]+y[x][f]);C+=$*$}var O=(((c*c-3*c+3)*j-c*C+3*h*h)*k*k+-((c*c-c)*j-2*c*C+3*h*h)*A+-(2*c*j-(c+3)*C+6*h*h)*F*F*k+(4*(c-1)*j-2*(c+1)*C+8*h*h)*F*D+(j-C+h*h)*F*F*F*F)/(Math.pow(F*F-k,2)*R)-M*M,Z=(G-E)/Math.sqrt(V),q=(z-M)/Math.sqrt(O),K=1-r(Z),N=1-r(q),B=[],J=[];for(f=0;f<c;f++)y[f][f]=1,h+=y[f][f];var Q=0,U=0;for(f=0;f<c;f++)Q+=g[f],U+=g[f]*g[f];var W=0,X=0;for(f=0;f<c;f++){var Y=0,ee=0;for(x=0;x<c;x++)Y+=y[f][x]*g[x],ee+=y[f][x];var oe,te=Q/c,ne=ee*(c-ee)*(U/c-te*te)/(c*c*(c-1)*te*te);(J=1-r(((B=Y/Q)-ee/c)/Math.sqrt(ne)))<.05&&g[f]>0?(W++,(oe=l[f].clone()).setStyle(m),a.addFeature(oe),console.log(oe.get("Cve_Casa")+": "+J)):J>.95&&X++,B[f]=B,J[f]=J}return w.setSource(a),w.setVisible(!0),w.setMap(_),{I:G,E_I:E,Var_I:V,Z_I:Z,p_I:K,G:z,E_G:M,Var_G:O,Z_G:q,p_G:N,Gi:B,highs:W,lows:X}}($("#select-localidad").val(),$("#distance-number").val()),a="<strong>I: </strong>"+n(e.I,4)+", <strong>p: </strong>"+n(e.p_I,4)+"<br>";a+="<strong>G: </strong>"+n(e.G,4)+", <strong>p: </strong>"+n(e.p_G,4)+"<br>",a+="<strong>Puntos Gi* (p<=0.05): </strong>"+e.highs+"<br>",$("#stats").html(a)})};
